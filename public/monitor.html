<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Baby Monitor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-aFq/bzH65dt+w6FI2ooMVUpc+21e0SRygnTpmBvdBgSdnuTN7QbdgL+OapgHtvPp" crossorigin="anonymous">
</head>

<body>
  <main class="container">
    <video id="remoteVideo" autoplay playsinline></video>
    <button id="answerButton" class="btn btn-primary">Answer</button>
  </main>

  <script>
    const remoteVideo = document.getElementById('remoteVideo');
    const answerButton = document.getElementById('answerButton');

    const ws = new WebSocket('wss://10.64.227.111:8000/ws');
    ws.onopen = () => {
      ws.send(JSON.stringify({
        type: "register",
        register: {
          id: "monitor",
          peer_ids: ["camera"],
        }
      }))
    }
    ws.onclose = console.log
    ws.onerror = console.error

    const pc = new RTCPeerConnection({
      iceServers: [
        {
          urls: ['stun:10.64.227.111:3478'],
          username: '',
          credential: '',
        },
        {
          urls: ['turn:10.64.227.111:3478'],
          username: '1680170375',
          credential: '69pVVHmO0rQ81RuNBV0Tn0/0zZU=',
        },
      ],
      iceTransportPolicy: "all",
      iceCandidatePoolSize: 10,
    });
    pc.onconnectionstatechange = console.log
    pc.onicecandidate = console.log
    pc.onicecandidateerror = console.log
    pc.oniceconnectionstatechange = console.log
    pc.onicegatheringstatechange = console.log
    pc.ontrack = (event) => {
      console.log(event)
      if (remoteVideo.srcObject) return
      remoteVideo.srcObject = event.streams[0];
    };

    ws.onmessage = async (event) => {
      console.log(event)
      const data = JSON.parse(event.data).data;
      switch (data.type) {
        case 'offer':
          await pc.setRemoteDescription(data);
          break;
        case 'candidate':
          const candidate = new RTCIceCandidate(data.candidate);
          await pc.addIceCandidate(candidate);
          break;
      }
    };

    answerButton.onclick = async () => {
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      ws.send(JSON.stringify({
        type: 'data',
        to_peer_id: 'camera',
        data: answer,
      }));
    };
  </script>
</body>

</html>