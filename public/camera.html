<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Baby Monitor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-aFq/bzH65dt+w6FI2ooMVUpc+21e0SRygnTpmBvdBgSdnuTN7QbdgL+OapgHtvPp" crossorigin="anonymous">
</head>

<body>
  <main class="container">
    <select id="webcam-selector" class="form-control">
      <option value="">Select a camera</option>
    </select>
    <video id="localVideo" style="max-width: 100vw;" autoplay muted playsinline></video>
    <button id="createOffer" class="btn btn-primary">
      Call
    </button>
  </main>

  <script>
    const localVideo = document.getElementById('localVideo');
    const createOfferButton = document.getElementById('createOffer');
    const webcamSelector = document.getElementById('webcam-selector');

    navigator.mediaDevices.enumerateDevices().then((devices) => {
      console.log(devices)
      const videoDevices = devices.filter(device => device.kind === 'videoinput');
      videoDevices.forEach((device, i) => {
        const option = document.createElement('option');
        option.value = device.deviceId;
        option.text = device.label || `Camera ${i + 1}`;
        webcamSelector.appendChild(option);
      });
    });

    const ws = new WebSocket('wss://10.64.227.111:8000/ws');
    ws.onopen = () => {
      ws.send(JSON.stringify({
        type: "register",
        register: {
          id: "camera",
          peer_ids: ["monitor"],
        }
      }))
    }
    ws.onclose = console.log
    ws.onerror = console.error

    const pc = new RTCPeerConnection({
      iceServers: [
        {
          urls: ['stun:10.64.227.111:3478'],
          username: '',
          credential: '',
        },
        {
          urls: ['turn:10.64.227.111:3478'],
          username: '1680170375',
          credential: '69pVVHmO0rQ81RuNBV0Tn0/0zZU=',
        },
      ],
      iceTransportPolicy: "all",
      iceCandidatePoolSize: 10,
    });
    pc.onconnectionstatechange = console.log
    pc.onicecandidate = (event) => {
      if (!event.candidate) return
      ws.send(JSON.stringify({
        type: 'data',
        to_peer_id: 'monitor',
        data: {
          type: 'candidate',
          candidate: event.candidate,
        }
      }))
    }
    pc.onicecandidateerror = console.log
    pc.oniceconnectionstatechange = console.log
    pc.onicegatheringstatechange = console.log
    const candidates = [];

    webcamSelector.onchange = async () => {
      if (!webcamSelector.value) return
      const stream = await navigator.mediaDevices.getUserMedia({
        video: {
          deviceId: webcamSelector.value,
        },
        audio: true,
      });
      localVideo.srcObject = stream;
      stream.getTracks().forEach(track => pc.addTrack(track, stream));
    };

    createOfferButton.onclick = async () => {
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      ws.send(JSON.stringify({
        type: 'data',
        to_peer_id: 'monitor',
        data: offer,
      }))
    };

    ws.onmessage = async (event) => {
      const data = JSON.parse(event.data).data;
      if (data.type !== 'answer') return
      await pc.setRemoteDescription(data);
    }
  </script>
</body>

</html>